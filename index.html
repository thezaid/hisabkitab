<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hisab Kitab</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J95YDM55T8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J95YDM55T8');
    </script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            50: '#F9F9FA',
                            100: '#F2F2F7',
                            200: '#E5E5EA',
                            300: '#D1D1D6',
                            400: '#C7C7CC',
                            500: '#AEAEB2',
                            600: '#8E8E93',
                            700: '#636366',
                            800: '#3A3A3C',
                            900: '#1C1C1E',
                        },
                        blue: {
                            500: '#007AFF',
                            600: '#0056B3',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.04)',
                        'hover': '0 8px 30px rgba(0, 0, 0, 0.08)',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1)',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F2F2F7;
            color: #1C1C1E;
            -webkit-tap-highlight-color: transparent;
        }

        .modern-card {
            background-color: #FFFFFF;
            border-radius: 1.25rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.02);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .modern-card:active { transform: scale(0.98); }

        /* Remove Spinners from Number Input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        input:focus, button:focus { outline: none; }

        .peer:checked ~ .radio-card {
            border-color: #007AFF;
            background-color: #F0F8FF;
            box-shadow: 0 0 0 2px #007AFF inset;
        }
        .peer:checked ~ .radio-card .check-icon { opacity: 1; transform: scale(1); }
        
        .radio-chip {
            background-color: #FFFFFF;
            border: 1px solid #D1D1D6;
            color: #1C1C1E;
        }
        .peer:checked ~ .radio-chip {
            border-color: transparent;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        
        input[value="Kirana"]:checked ~ .radio-chip { background-color: #34C759; }
        input[value="Gosht"]:checked ~ .radio-chip { background-color: #FF3B30; }
        input[value="Kheema"]:checked ~ .radio-chip { background-color: #FF9500; }
        input[value="Gosht Kheema"]:checked ~ .radio-chip { background-color: #FF3B30; }
        input[value="Chicken"]:checked ~ .radio-chip { background-color: #FFCC00; color: black; }
        input[value="Mutton"]:checked ~ .radio-chip { background-color: #FF3B30; }
        input[value="Bheja"]:checked ~ .radio-chip { background-color: #FF2D55; }
        input[value="Fish"]:checked ~ .radio-chip { background-color: #5AC8FA; }
        input[value="Light Bill"]:checked ~ .radio-chip { background-color: #5856D6; }
        input[value="Society"]:checked ~ .radio-chip { background-color: #30B0C7; }

        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-[100dvh] w-full overflow-hidden text-sm sm:text-base font-sans antialiased selection:bg-blue-500 selection:text-white">

    <!-- Auth Container -->
    <div id="auth-container" class="fixed inset-0 flex items-center justify-center p-6 z-50 bg-[#F2F2F7]">
        <div class="w-full max-w-sm modern-card p-8 animate-slide-up">
            <div id="auth-ui" class="text-center transition-all duration-300">
                <div class="mb-6 flex justify-center">
                    <div class="h-16 w-16 rounded-3xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <svg class="w-9 h-9 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2 tracking-tight">Hisab Kitab</h1>
                <p class="text-gray-500 mb-8 font-medium text-base">Sign in to manage your expenses.</p>
                <form id="login-form" class="space-y-5 text-left">
                    <div>
                        <input type="email" id="email" placeholder="Email" required 
                            class="w-full bg-gray-100 border-none text-gray-900 rounded-2xl px-5 py-4 focus:ring-2 focus:ring-blue-500/50 transition-all placeholder-gray-400 font-medium text-lg">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="Password" required 
                            class="w-full bg-gray-100 border-none text-gray-900 rounded-2xl px-5 py-4 focus:ring-2 focus:ring-blue-500/50 transition-all placeholder-gray-400 font-medium text-lg">
                    </div>
                    <div class="flex items-center justify-between py-2 px-1">
                        <label class="flex items-center cursor-pointer group">
                            <input id="remember-me" type="checkbox" checked class="rounded-md border-gray-300 text-blue-600 focus:ring-blue-500 w-5 h-5">
                            <span class="ml-3 text-base text-gray-500 font-medium">Remember me</span>
                        </label>
                        <a href="#" id="forgot-password-link" class="text-base text-blue-600 font-semibold hover:text-blue-700">Reset password?</a>
                    </div>
                    <button type="submit" id="login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-2xl py-4 transition-all transform active:scale-[0.98] shadow-lg shadow-blue-500/20 flex items-center justify-center tracking-wide text-lg">
                        <span id="login-text">Sign In</span>
                        <div id="login-spinner" class="loader hidden ml-2"></div>
                    </button>
                </form>
                <div class="mt-8 pt-6 border-t border-gray-100">
                    <button id="signup-button" class="text-base text-gray-500 hover:text-gray-800 transition-colors font-medium">Don't have an account? <span class="text-blue-600 font-semibold">Request access</span></button>
                </div>
            </div>
            
            <div id="password-reset-ui" class="hidden text-center">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Reset Password</h2>
                <p class="text-gray-500 text-base mb-6 font-medium">Enter your email for a recovery link.</p>
                <form id="password-reset-form" class="space-y-4">
                    <input type="email" id="reset-email" placeholder="Email Address" required class="w-full bg-gray-100 border-none text-gray-900 rounded-2xl px-5 py-4 focus:ring-2 focus:ring-blue-500/50 transition-all font-medium text-lg">
                    <button type="submit" id="reset-btn" class="w-full bg-black text-white font-bold rounded-2xl py-4 hover:bg-gray-800 transition-colors flex justify-center items-center shadow-lg text-lg">
                        <span id="reset-text">Send Link</span>
                        <div id="reset-spinner" class="loader border-gray-400 border-t-transparent hidden ml-2"></div>
                    </button>
                </form>
                <button id="reset-go-back-button" class="mt-6 text-gray-500 hover:text-black text-base font-semibold">Back to Login</button>
            </div>
            
            <div id="contact-ui" class="hidden text-center">
                <div class="h-16 w-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Request Access</h2>
                <p class="text-gray-500 text-base mb-6 font-medium">Please contact the administrator:</p>
                <a href="mailto:me@zaid.ovh" class="block bg-gray-50 border border-gray-200 rounded-2xl p-5 text-blue-600 font-mono text-base mb-8 hover:bg-white hover:shadow-sm transition-all font-medium">me@zaid.ovh</a>
                <button id="go-back-button" class="text-gray-500 hover:text-black text-base font-semibold">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden fixed inset-0 flex flex-col bg-[#F2F2F7]">
        <header class="flex-none pt-safe-top z-40 bg-[#F2F2F7]/80 backdrop-blur-xl border-b border-gray-200 sticky top-0">
            <div class="px-5 py-4 flex items-center justify-between max-w-md mx-auto w-full">
                <h1 class="text-2xl font-bold tracking-tight text-gray-900">Hisab Kitab</h1>
                
                <!-- User Menu -->
                <div class="relative">
                    <button id="user-menu-btn" class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-gray-200 shadow-sm transition-all active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span id="user-email-display-header" class="text-xs text-gray-600 font-medium truncate max-w-[120px]"></span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    
                    <!-- Dropdown -->
                    <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 py-1 z-50 origin-top-right transform transition-all">
                        <button id="menu-help-btn" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3 font-medium transition-colors">
                            <svg class="w-4 h-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                            Help & Support
                        </button>
                        <div class="h-px bg-gray-50 my-1"></div>
                        <button id="menu-logout-btn" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 font-medium transition-colors">
                            <!-- Spinner Container -->
                            <div id="menu-logout-spinner" class="loader border-red-500 border-t-transparent hidden h-4 w-4"></div>
                            <svg id="menu-logout-icon" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto px-4 pb-safe-bottom scroll-smooth">
            <div class="max-w-md mx-auto w-full pt-6 pb-12">
                
                <form id="data-form" class="space-y-8" novalidate>
                    <div class="space-y-3">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-widest ml-1">Payer</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="cursor-pointer relative group">
                                <input type="radio" name="name" value="Gulnaz Dena" class="peer sr-only">
                                <div class="radio-card h-28 rounded-2xl bg-white border border-gray-200 flex flex-col items-center justify-center transition-all duration-200 hover:shadow-md">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-purple-100 to-purple-200 flex items-center justify-center text-purple-600 font-bold text-sm mb-3">GUL</div>
                                    <span class="text-base font-semibold text-gray-700">Gulnaz Dena</span>
                                    <div class="check-icon absolute top-3 right-3 opacity-0 transform scale-50 transition-all duration-200">
                                        <div class="bg-blue-500 rounded-full p-1"><svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg></div>
                                    </div>
                                </div>
                            </label>
                            <label class="cursor-pointer relative group">
                                <input type="radio" name="name" value="Ghazala Dena" class="peer sr-only">
                                <div class="radio-card h-28 rounded-2xl bg-white border border-gray-200 flex flex-col items-center justify-center transition-all duration-200 hover:shadow-md">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-teal-100 to-teal-200 flex items-center justify-center text-teal-700 font-bold text-sm mb-3">GAZ</div>
                                    <span class="text-base font-semibold text-gray-700">Ghazala Dena</span>
                                    <div class="check-icon absolute top-3 right-3 opacity-0 transform scale-50 transition-all duration-200">
                                        <div class="bg-blue-500 rounded-full p-1"><svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg></div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-3">
                         <label for="amount" class="text-xs font-bold text-gray-500 uppercase tracking-widest ml-1">Amount</label>
                        <div class="relative modern-card overflow-hidden">
                            <div class="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none">
                                <span class="text-gray-300 text-2xl font-light">₹</span>
                            </div>
                            <!-- Modified Input: Strict Positive Integer Validation -->
                            <input type="number" id="amount" name="amount" placeholder="0" inputmode="numeric" 
                                onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                class="block w-full bg-transparent border-none py-6 pl-12 pr-6 text-4xl font-bold text-gray-900 placeholder-gray-300 focus:ring-0 text-center tracking-tight">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-widest ml-1">Category</label>
                        <div class="flex flex-wrap gap-2.5">
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Kirana" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Kirana</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Gosht" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Gosht</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Kheema" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Kheema</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Gosht Kheema" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Gosht Kheema</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Chicken" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Chicken</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Mutton" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Mutton</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Bheja" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Bheja</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Fish" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Fish</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Light Bill" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Light Bill</span></label>
                            <label class="cursor-pointer"><input type="radio" name="tag" value="Society" class="peer sr-only"><span class="radio-chip inline-block px-5 py-3 rounded-full text-sm font-semibold transition-all">Society</span></label>
                        </div>
                        <div class="relative mt-2">
                            <input type="text" id="other-tag-input" name="other-tag" placeholder="Or type something else..." 
                                class="w-full px-5 py-4 rounded-xl bg-white border border-gray-200 text-gray-900 text-base font-medium focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-all placeholder-gray-400 shadow-sm">
                        </div>
                    </div>

                    <div class="pt-4 flex gap-4">
                        <button type="reset" class="px-6 py-4 rounded-2xl bg-white border border-gray-200 text-gray-500 font-semibold hover:bg-gray-50 transition-colors active:scale-95 shadow-sm text-base">Clear</button>
                        <button type="submit" id="submit-button" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold text-lg rounded-2xl py-4 shadow-lg shadow-blue-500/30 transition-all transform active:scale-[0.98] flex items-center justify-center tracking-wide">
                            <span id="submit-text">Save Entry</span>
                            <div id="submit-spinner" class="loader ml-3 hidden"></div>
                        </button>
                    </div>
                </form>

                <div id="recent-entries-wrapper" class="mt-12 mb-8 animate-slide-up" style="animation-delay: 0.1s;">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">Recent Activity</h3>
                    <div id="recent-entries" class="space-y-3"></div>
                </div>

                <div class="mb-8 animate-slide-up" style="animation-delay: 0.15s;">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">Net Balance</h3>
                    <div id="homepage-summary" class="modern-card p-5 flex flex-col justify-between hidden">
                        <!-- Loading Skeleton for Summary -->
                    </div>
                </div>

                <div class="animate-slide-up" style="animation-delay: 0.2s;">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Feed View -->
                        <button id="open-feed-btn" class="modern-card p-5 flex flex-col items-center justify-center gap-3 hover:bg-gray-50 transition-colors group h-28">
                            <div class="p-3 rounded-full bg-blue-50 group-hover:bg-blue-100 transition-colors"><svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg></div>
                            <span class="text-base font-semibold text-gray-700">Feed</span>
                        </button>
                        
                        <!-- Ledger View -->
                        <button id="open-ledger-btn" class="modern-card p-5 flex flex-col items-center justify-center gap-3 hover:bg-gray-50 transition-colors group h-28">
                            <div class="p-3 rounded-full bg-indigo-50 group-hover:bg-indigo-100 transition-colors"><svg class="w-6 h-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7-4h14m-7-4v8m-9-4h14" /></svg></div>
                            <span class="text-base font-semibold text-gray-700">Ledger</span>
                        </button>
                        
                        <!-- Calendar View -->
                        <button id="open-calendar-btn" class="modern-card p-5 flex flex-col items-center justify-center gap-3 hover:bg-gray-50 transition-colors group h-28">
                            <div class="p-3 rounded-full bg-purple-50 group-hover:bg-purple-100 transition-colors"><svg class="w-6 h-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>
                            <span class="text-base font-semibold text-gray-700">Calendar</span>
                        </button>
                        
                        <!-- Split View -->
                        <button id="open-split-btn" class="modern-card p-5 flex flex-col items-center justify-center gap-3 hover:bg-gray-50 transition-colors group h-28">
                            <div class="p-3 rounded-full bg-teal-50 group-hover:bg-teal-100 transition-colors"><svg class="w-6 h-6 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div>
                            <span class="text-base font-semibold text-gray-700">Split</span>
                        </button>

                        <!-- Analytics Full Width -->
                        <button id="trend-chart-btn" class="modern-card p-5 flex flex-col items-center justify-center gap-3 hover:bg-gray-50 transition-colors group h-28 col-span-2">
                            <div class="p-3 rounded-full bg-pink-50 group-hover:bg-pink-100 transition-colors"><svg class="w-6 h-6 text-pink-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg></div>
                            <span class="text-base font-semibold text-gray-700">Analytics</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- View Entries Modal -->
    <div id="entries-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center sm:items-center p-0 sm:p-4 text-center">
                <div class="relative transform overflow-hidden bg-white text-left shadow-2xl transition-all w-full sm:max-w-lg sm:rounded-2xl h-[92vh] sm:h-auto flex flex-col rounded-t-2xl">
                    
                    <!-- Modal Header -->
                    <div class="bg-white px-4 py-4 sm:px-6 flex justify-between items-center border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900" id="modal-title">Transaction Feed</h3>
                        <button id="close-modal-btn" class="bg-gray-100 rounded-full p-2 text-gray-500 hover:bg-gray-200 transition-colors"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    </div>

                    <!-- Controls: Filters, Sort (Selector Removed) -->
                    <div id="modal-controls" class="bg-gray-50 px-4 py-4 border-b border-gray-100 space-y-3">
                        
                        <!-- Search -->
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            </div>
                            <input type="text" id="filter-input" placeholder="Search..." class="block w-full rounded-xl bg-white border border-gray-200 py-2.5 pl-10 pr-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500/20 sm:text-sm font-medium outline-none">
                        </div>

                        <!-- Filters Row -->
                        <div class="flex gap-2">
                            <!-- Time Filter Container -->
                            <div class="relative flex-1 group" id="time-filter-container">
                                <!-- Standard Dropdown -->
                                <select id="time-filter" class="w-full appearance-none bg-white border border-gray-200 text-gray-700 py-2.5 px-3 pr-8 rounded-xl text-xs font-semibold focus:outline-none focus:border-blue-500 transition-all">
                                    <option value="all">All Time</option>
                                    <option value="this_month">This Month</option>
                                    <option value="last_month">Last Month</option>
                                    <option value="last_30">Last 30 Days</option>
                                    <option disabled>──────────</option>
                                    <option value="custom_date">Specific Date...</option>
                                    <option value="custom_month">Specific Month...</option>
                                    <option value="custom_year">Specific Year...</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500" id="time-filter-icon"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>

                                <!-- Hidden Custom Inputs -->
                                <div id="custom-input-wrapper" class="hidden absolute inset-0 bg-white rounded-xl border border-gray-200 flex items-center px-2 shadow-sm z-10">
                                    <input type="date" id="custom-date-input" class="hidden w-full text-xs font-semibold text-gray-900 focus:outline-none bg-transparent">
                                    <input type="month" id="custom-month-input" class="hidden w-full text-xs font-semibold text-gray-900 focus:outline-none bg-transparent">
                                    <select id="custom-year-input" class="hidden w-full text-xs font-semibold text-gray-900 focus:outline-none bg-transparent appearance-none"></select>
                                    <button id="clear-custom-filter" class="ml-2 text-gray-400 hover:text-red-500 p-1"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                                </div>
                            </div>

                            <!-- Sort Filter -->
                            <div class="relative flex-1">
                                <select id="sort-filter" class="w-full appearance-none bg-white border border-gray-200 text-gray-700 py-2.5 px-3 pr-8 rounded-xl text-xs font-semibold focus:outline-none focus:border-blue-500 transition-all">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="high_low">Amount: High-Low</option>
                                    <option value="low_high">Amount: Low-High</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div id="entries-content-area" class="flex-1 overflow-y-auto p-0 bg-gray-50">
                        <!-- JS Injected Table/Feed -->
                    </div>

                    <!-- Footer -->
                    <div id="load-more-container" class="bg-white px-4 py-4 border-t border-gray-100 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="trend-chart-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto p-4 flex items-center justify-center">
            <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col">
                 <div class="flex justify-between items-center p-4 border-b border-gray-100">
                    <h2 class="text-gray-900 font-bold text-lg">Analytics</h2>
                    <button id="close-trend-chart-btn" class="text-gray-400 hover:text-gray-600 p-2"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="flex-1 overflow-hidden bg-gray-50 p-2 rounded-b-2xl">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRYy1LaCl91me7-ViRJrzlJe1f9qWs3Qy1nA1sRww_RF7GObcrhgHf8y1jHffYdv0g9K6eX2IiIj65Z/pubchart?oid=1363302817&format=interactive" width="100%" height="100%" frameborder="0" style="border:0"></iframe>
                </div>
            </div>
        </div>
    </div>

    <div id="help-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Help & Support</h2>
                    <button id="close-help-modal-btn" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="space-y-4 text-base text-gray-600">
                    <div class="p-4 bg-red-50 border border-red-100 rounded-xl"><h3 class="text-red-600 font-bold mb-1 flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Reporting Bugs</h3><p class="text-gray-600 font-medium">Please screenshot the error and email us with your device details.</p></div>
                    <div class="p-4 bg-blue-50 border border-blue-100 rounded-xl"><h3 class="text-blue-600 font-bold mb-1">Contact</h3><p class="font-medium">Email: <a href="mailto:me@zaid.ovh" class="text-blue-600 hover:underline">me@zaid.ovh</a></p></div>
                    <div class="p-4 bg-gray-50 border border-gray-100 rounded-xl"><h3 class="text-yellow-600 font-bold mb-1">Tips</h3><ul class="list-disc list-inside text-gray-500 space-y-1 font-medium"><li>Use whole numbers only.</li><li>If the app freezes, disable AdBlock.</li><li>Tap "Other" to type a custom tag.</li></ul></div>
                </div>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-white border border-gray-200 text-gray-900 px-6 py-4 rounded-full shadow-xl z-[100] transition-all duration-300 scale-0 flex items-center">
        <div id="msg-indicator" class="w-2 h-2 rounded-full bg-green-500 mr-3"></div>
        <p id="message-text" class="text-sm font-bold"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";
        const firebaseAnalyticsConfig = { apiKey: "AIzaSyA5bKSAZN0JHAK_atwbSRz4dCTJ8NaH4vI", authDomain: "auth-demo-9a4bc.firebaseapp.com", projectId: "auth-demo-9a4bc", storageBucket: "auth-demo-9a4bc.firebasestorage.app", messagingSenderId: "554871726025", appId: "1:554871726025:web:ec8d1171f6a85b13c65218", measurementId: "G-J95YDM55T8" };
        const analyticsApp = initializeApp(firebaseAnalyticsConfig, 'analytics');
        const analytics = getAnalytics(analyticsApp);
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyA5bKSAZN0JHAK_atwbSRz4dCTJ8NaH4vI", authDomain: "auth-demo-9a4bc.firebaseapp.com", projectId: "auth-demo-9a4bc", storageBucket: "auth-demo-9a4bc.firebasestorage.app", messagingSenderId: "554871726025", appId: "1:554871726025:web:ec8d1171f6a85b13c65218" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        const authContainer = document.getElementById('auth-container');
        const authUi = document.getElementById('auth-ui');
        const contactUi = document.getElementById('contact-ui');
        const passwordResetUi = document.getElementById('password-reset-ui');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const signupButton = document.getElementById('signup-button');
        const goBackButton = document.getElementById('go-back-button');
        // const logoutButton = document.getElementById('logout-button'); // Removed direct ref
        const userEmailDisplay = document.getElementById('user-email-display-header');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const passwordResetForm = document.getElementById('password-reset-form');
        const resetGoBackButton = document.getElementById('reset-go-back-button');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwoFc2VyGtJMtFIh2D_qf99BBFLNfQLnFO5MjFv3EtKL3AYYj0C9uNpvmAh-eYy-cisMg/exec'; 
        const INITIAL_LOAD_COUNT = 50;
        
        let sessionStartTime;
        let allEntries = [];
        let filteredEntries = [];
        let visibleCount = INITIAL_LOAD_COUNT;
        let deviceDetails = {};
        
        // Modal State
        let currentView = 'feed'; 
        let currentFilter = 'all'; 
        let currentSort = 'newest';
        
        // Custom Filter Values
        let customDateVal = '';
        let customMonthVal = '';
        let customYearVal = '';
        
        // Calendar Navigation State
        let calendarViewDate = new Date();

        const trackEvent = (eventName, parameters = {}) => { if (typeof gtag !== 'undefined') gtag('event', eventName, parameters); };

        // Helper: Robust Date Parsing for Safari/Mobile
        const parseDate = (dateStr) => {
            if (!dateStr) return new Date();
            // Try standard parsing
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d;
            
            // Handle "yyyy-mm-dd hh:mm:ss" which often fails on Safari/iOS
            // Replacing dashes with slashes usually fixes it for basic JS Date parsing
            if (typeof dateStr === 'string') {
                const safeStr = dateStr.replace(/-/g, '/'); 
                d = new Date(safeStr);
                if (!isNaN(d.getTime())) return d;
            }
            return new Date(); // Fallback to current date on total failure to prevent crash
        };

        const showButtonSpinner = (buttonId, textId, spinnerId) => { document.getElementById(buttonId).disabled = true; document.getElementById(textId).style.display = 'none'; document.getElementById(spinnerId).classList.remove('hidden'); };
        // Updated Logout Spinner Logic for Menu Item
        const showLogoutSpinner = () => { 
            const btn = document.getElementById('menu-logout-btn');
            btn.disabled = true; 
            document.getElementById('menu-logout-icon').classList.add('hidden'); 
            document.getElementById('menu-logout-spinner').classList.remove('hidden'); 
        };
        const hideLogoutSpinner = () => { 
            const btn = document.getElementById('menu-logout-btn');
            btn.disabled = false; 
            document.getElementById('menu-logout-icon').classList.remove('hidden'); 
            document.getElementById('menu-logout-spinner').classList.add('hidden'); 
        };
        const hideButtonSpinner = (buttonId, textId, spinnerId, originalText) => { document.getElementById(buttonId).disabled = false; document.getElementById(textId).style.display = 'inline'; document.getElementById(textId).textContent = originalText; document.getElementById(spinnerId).classList.add('hidden'); };
        const showMessage = (message, isError = true) => { messageText.textContent = message; const indicator = document.getElementById('msg-indicator'); if (isError) { indicator.classList.remove('bg-green-500'); indicator.classList.add('bg-red-500'); trackEvent('error_message_shown', { message: message }); } else { indicator.classList.remove('bg-red-500'); indicator.classList.add('bg-green-500'); trackEvent('success_message_shown', { message: message }); } messageBox.classList.remove('scale-0'); messageBox.classList.add('scale-100'); setTimeout(() => { messageBox.classList.remove('scale-100'); messageBox.classList.add('scale-0'); }, 5000); };

        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = e.target.email.value; const password = e.target.password.value; const rememberMe = rememberMeCheckbox.checked; trackEvent('login_attempt', { email: email }); showButtonSpinner('login-btn', 'login-text', 'login-spinner'); try { await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence); await signInWithEmailAndPassword(auth, email, password); showMessage("Signed in successfully", false); trackEvent('login_success', { email: email, remember_me: rememberMe }); } catch (error) { showMessage("Incorrect password or email"); trackEvent('login_error', { error: error.message }); } finally { hideButtonSpinner('login-btn', 'login-text', 'login-spinner', 'Sign In'); } });
        forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); authUi.classList.add('hidden'); passwordResetUi.classList.remove('hidden'); trackEvent('forgot_password_clicked'); });
        passwordResetForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = e.target['reset-email'].value; trackEvent('password_reset_attempt', { email: email }); showButtonSpinner('reset-btn', 'reset-text', 'reset-spinner'); try { await sendPasswordResetEmail(auth, email); showMessage("Reset link sent to your email", false); passwordResetForm.reset(); trackEvent('password_reset_success', { email: email }); } catch (error) { showMessage(error.message); trackEvent('password_reset_error', { error: error.message }); } finally { hideButtonSpinner('reset-btn', 'reset-text', 'reset-spinner', 'Send Link'); } });
        signupButton.addEventListener('click', () => { authUi.classList.add('hidden'); contactUi.classList.remove('hidden'); trackEvent('signup_button_clicked'); });
        goBackButton.addEventListener('click', () => { contactUi.classList.add('hidden'); authUi.classList.remove('hidden'); trackEvent('go_back_clicked'); });
        resetGoBackButton.addEventListener('click', () => { passwordResetUi.classList.add('hidden'); authUi.classList.remove('hidden'); trackEvent('reset_go_back_clicked'); });
        
        onAuthStateChanged(auth, (user) => { if (user) { authContainer.classList.add('hidden'); appContainer.classList.remove('hidden'); userEmailDisplay.textContent = user.email; trackEvent('user_authenticated', { email: user.email }); initializeHisabKitabApp(); } else { authContainer.classList.remove('hidden'); appContainer.classList.add('hidden'); authUi.classList.remove('hidden'); contactUi.classList.add('hidden'); passwordResetUi.classList.add('hidden'); trackEvent('user_signed_out'); } });

        function initializeHisabKitabApp() {
            sessionStartTime = new Date();
            trackEvent('app_initialized');
            
            const form = document.getElementById('data-form');
            // const viewEntriesBtn = document.getElementById('view-entries-btn'); // Removed old btn
            // const helpFeedbackBtn = document.getElementById('help-feedback-btn'); // Moved to menu
            const trendChartBtn = document.getElementById('trend-chart-btn');
            const entriesModal = document.getElementById('entries-modal');
            const helpModal = document.getElementById('help-modal');
            const trendChartModal = document.getElementById('trend-chart-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const closeHelpModalBtn = document.getElementById('close-help-modal-btn');
            const closeTrendChartBtn = document.getElementById('close-trend-chart-btn');
            
            // Header Menu Elements
            const userMenuBtn = document.getElementById('user-menu-btn');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            const menuHelpBtn = document.getElementById('menu-help-btn');
            const menuLogoutBtn = document.getElementById('menu-logout-btn');

            // Modal Logic Controls
            // Removed view toggles
            const filterInput = document.getElementById('filter-input');
            
            // New Home Action Buttons
            const openFeedBtn = document.getElementById('open-feed-btn');
            const openLedgerBtn = document.getElementById('open-ledger-btn');
            const openCalendarBtn = document.getElementById('open-calendar-btn');
            const openSplitBtn = document.getElementById('open-split-btn');

            // New Filter Controls
            const timeFilterSelect = document.getElementById('time-filter');
            const customInputWrapper = document.getElementById('custom-input-wrapper');
            const customDateInput = document.getElementById('custom-date-input');
            const customMonthInput = document.getElementById('custom-month-input');
            const customYearInput = document.getElementById('custom-year-input');
            const clearCustomFilterBtn = document.getElementById('clear-custom-filter');
            const sortFilterSelect = document.getElementById('sort-filter');

            form.addEventListener('submit', handleFormSubmit);
            
            // New Home Button Listeners
            openFeedBtn.addEventListener('click', () => openEntriesModal('feed'));
            openLedgerBtn.addEventListener('click', () => openEntriesModal('ledger'));
            openCalendarBtn.addEventListener('click', () => openEntriesModal('calendar'));
            openSplitBtn.addEventListener('click', () => openEntriesModal('split'));

            // Header Menu Logic
            userMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                userMenuDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!userMenuDropdown.contains(e.target) && !userMenuBtn.contains(e.target)) {
                    userMenuDropdown.classList.add('hidden');
                }
            });

            // Menu Item Listeners
            menuHelpBtn.addEventListener('click', () => { 
                helpModal.classList.remove('hidden'); 
                userMenuDropdown.classList.add('hidden');
                trackEvent('help_feedback_opened'); 
            });
            
            menuLogoutBtn.addEventListener('click', async () => { 
                trackEvent('logout_attempt'); 
                showLogoutSpinner(); 
                try { 
                    await signOut(auth); 
                    showMessage("Signed out", false); 
                    trackEvent('logout_success'); 
                } catch (error) { 
                    showMessage(error.message); 
                    trackEvent('logout_error', { error: error.message }); 
                } finally { 
                    hideLogoutSpinner(); 
                } 
            });

            // Filter Logic - Main Search
            filterInput.addEventListener('input', applyFilters);
            
            // Filter Logic - Time Dropdown
            timeFilterSelect.addEventListener('change', (e) => {
                const val = e.target.value;
                if (val === 'custom_date' || val === 'custom_month' || val === 'custom_year') {
                    // Switch UI to custom input mode
                    customInputWrapper.classList.remove('hidden');
                    customDateInput.classList.add('hidden');
                    customMonthInput.classList.add('hidden');
                    customYearInput.classList.add('hidden');
                    
                    if (val === 'custom_date') {
                        customDateInput.classList.remove('hidden');
                        customDateInput.focus();
                        if(customDateInput.showPicker) customDateInput.showPicker(); 
                    } else if (val === 'custom_month') {
                        customMonthInput.classList.remove('hidden');
                        customMonthInput.focus();
                        if(customMonthInput.showPicker) customMonthInput.showPicker();
                    } else if (val === 'custom_year') {
                        customYearInput.classList.remove('hidden');
                        populateYearOptions();
                        customYearInput.focus();
                    }
                    currentFilter = val; // Set filter type
                } else {
                    currentFilter = val;
                    applyFilters();
                }
            });

            // Filter Logic - Custom Inputs
            customDateInput.addEventListener('change', (e) => { customDateVal = e.target.value; applyFilters(); });
            customMonthInput.addEventListener('change', (e) => { customMonthVal = e.target.value; applyFilters(); });
            customYearInput.addEventListener('change', (e) => { customYearVal = e.target.value; applyFilters(); });

            // Clear Custom Filter Button
            clearCustomFilterBtn.addEventListener('click', () => {
                customInputWrapper.classList.add('hidden');
                timeFilterSelect.value = 'all';
                currentFilter = 'all';
                customDateVal = '';
                customMonthVal = '';
                customYearVal = '';
                customDateInput.value = '';
                customMonthInput.value = '';
                applyFilters();
            });

            sortFilterSelect.addEventListener('change', (e) => { currentSort = e.target.value; applyFilters(); });

            // helpFeedbackBtn.addEventListener('click', () => { helpModal.classList.remove('hidden'); trackEvent('help_feedback_opened'); }); // Moved
            closeHelpModalBtn.addEventListener('click', () => { helpModal.classList.add('hidden'); trackEvent('help_modal_closed'); });
            trendChartBtn.addEventListener('click', () => { trendChartModal.classList.remove('hidden'); trackEvent('trend_chart_opened'); });
            closeTrendChartBtn.addEventListener('click', () => { trendChartModal.classList.add('hidden'); trackEvent('trend_chart_closed'); });
            closeModalBtn.addEventListener('click', () => { entriesModal.classList.add('hidden'); trackEvent('entries_modal_closed'); });
            
            document.querySelectorAll('input[name="tag"]').forEach(r => r.addEventListener('change', handleTagChange));
            document.getElementById('other-tag-input').addEventListener('input', (e) => { if (e.target.value.trim()) { document.querySelectorAll('input[name="tag"]').forEach(radio => radio.checked = false); } trackEvent('other_tag_input_used', { value_length: e.target.value.length }); });
            
            fetchInitialData();
            getDeviceDetails();
        }

        // Removed updateToggleUI() as it's no longer needed

        const formatAmount = (num) => num ? Number(num).toLocaleString('en-IN') : '';
        
        const formatTimestamp = (dateStr) => {
            if (!dateStr) return '';
            const date = parseDate(dateStr); // Use robust parser
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            });
        }
        
        function handleTagChange() { const otherInput = document.getElementById('other-tag-input'); const checkedTag = document.querySelector('input[name="tag"]:checked'); if (checkedTag) otherInput.value = ''; trackEvent('tag_changed', { tag_selected: checkedTag ? checkedTag.value : 'other_input' }); }
        async function getDeviceDetails() { deviceDetails = { browserName: 'Unknown', osVersion: 'Unknown', manufacturer: 'Unknown', deviceModel: 'Unknown' }; const ua = navigator.userAgent; const platform = navigator.platform; if (/Win/.test(platform)) deviceDetails.osVersion = "Windows"; else if (/Mac/.test(platform)) deviceDetails.osVersion = "MacOS"; else if (/Linux/.test(platform)) deviceDetails.osVersion = "Linux"; else if (/iPhone|iPad|iPod/.test(ua)) deviceDetails.osVersion = "iOS"; else if (/Android/.test(ua)) deviceDetails.osVersion = "Android"; if (ua.includes("Firefox")) deviceDetails.browserName = "Firefox"; else if (ua.includes("Chrome")) deviceDetails.browserName = "Chrome"; else if (ua.includes("Safari")) deviceDetails.browserName = "Safari"; trackEvent('device_details_collected', deviceDetails); }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const amount = formData.get('amount');
            const checkedTag = document.querySelector('input[name="tag"]:checked');
            const otherTagInput = document.getElementById('other-tag-input');
            const tag = checkedTag ? checkedTag.value : otherTagInput.value.trim();
            
            trackEvent('form_submit_attempt', { name: name, amount: amount, tag: tag });
            if (!name) return showMessage('Select who paid');
            if (!amount) return showMessage('Enter an amount');
            if (!/^\d+$/.test(amount)) return showMessage('Whole numbers only');
            if (!tag) return showMessage('Select a category');
            showButtonSpinner('submit-button', 'submit-text', 'submit-spinner');
            const currentUser = auth.currentUser; const userEmail = currentUser ? currentUser.email : 'Unknown';
            const submitFormData = new FormData(); submitFormData.append('name', name); submitFormData.append('amount', amount); submitFormData.append('tag', tag); submitFormData.append('sessionDuration', `${Math.round((new Date() - sessionStartTime) / 1000)}s`); submitFormData.append('browserName', deviceDetails.browserName); submitFormData.append('osVersion', deviceDetails.osVersion); submitFormData.append('manufacturer', deviceDetails.manufacturer); submitFormData.append('deviceModel', deviceDetails.deviceModel); submitFormData.append('userEmail', userEmail);
            try { const response = await fetch(SCRIPT_URL, { method: 'POST', body: submitFormData }); if (!response.ok) throw new Error(`Network response was not ok`); const data = await response.json(); if (data.result !== "success") throw new Error(data.error || 'Server error.'); showMessage('Entry Saved!', false); e.target.reset(); fetchInitialData(); trackEvent('form_submit_success', { name: name, amount: amount, tag: tag, user_email: userEmail }); } catch (error) { console.error('Submission Error!', error); showMessage("Couldn't save. Try again."); trackEvent('form_submit_error', { error: error.message }); } finally { hideButtonSpinner('submit-button', 'submit-text', 'submit-spinner', 'Save Entry'); }
        }

        function openEntriesModal(initialView = 'feed') {
            document.getElementById('entries-modal').classList.remove('hidden');
            currentView = initialView;
            
            // Set Modal Title based on view
            const modalTitle = document.getElementById('modal-title');
            if (initialView === 'feed') modalTitle.textContent = 'Transaction Feed';
            else if (initialView === 'ledger') modalTitle.textContent = 'Transaction Ledger';
            else if (initialView === 'calendar') modalTitle.textContent = 'Expense Calendar';
            else if (initialView === 'split') modalTitle.textContent = 'Split Analysis';

            // Toggle Search/Filter Controls
            const modalControls = document.getElementById('modal-controls');
            // Toggle Content Area Scrolling
            const contentArea = document.getElementById('entries-content-area');

            if (initialView === 'calendar') {
                modalControls.classList.add('hidden');
                // Lock parent scroll for Calendar to allow internal split scrolling
                contentArea.classList.remove('overflow-y-auto');
                contentArea.classList.add('overflow-hidden');
            } else {
                modalControls.classList.remove('hidden');
                // Re-enable standard scrolling for other views
                contentArea.classList.add('overflow-y-auto');
                contentArea.classList.remove('overflow-hidden');
            }

            if (initialView === 'calendar') {
                // Initialize calendar date
                if (currentFilter === 'custom_month' && customMonthVal) {
                    const parts = customMonthVal.split('-');
                    calendarViewDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
                } else if (currentFilter === 'custom_date' && customDateVal) {
                    calendarViewDate = parseDate(customDateVal);
                } else {
                    calendarViewDate = new Date();
                }
                selectedCalendarDay = null;
            }
            
            applyFilters(); // This triggers renderEntries
            trackEvent('entries_modal_opened', { view: initialView });
        }

        async function fetchInitialData() {
            const recentEntriesContainer = document.getElementById('recent-entries');
            const homepageSummary = document.getElementById('homepage-summary');
            
            // Skeletons
            recentEntriesContainer.innerHTML = `<div class="modern-card p-4 animate-pulse"><div class="h-4 bg-gray-200 rounded w-3/4 mb-3"></div><div class="h-3 bg-gray-200 rounded w-1/4"></div></div><div class="modern-card p-4 animate-pulse delay-75"><div class="h-4 bg-gray-200 rounded w-3/4 mb-3"></div><div class="h-3 bg-gray-200 rounded w-1/4"></div></div>`;
            homepageSummary.classList.remove('hidden');
            homepageSummary.innerHTML = `<div class="animate-pulse space-y-4"><div class="h-4 bg-gray-200 rounded w-1/4"></div><div class="h-8 bg-gray-200 rounded w-3/4"></div><div class="h-4 bg-gray-200 rounded w-full"></div></div>`;

            try {
                const url = SCRIPT_URL + '?cacheBust=' + new Date().getTime();
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network error`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                allEntries = Array.isArray(data.entries) ? data.entries : [];
                renderRecentEntries(allEntries);
                renderSummary(data.summary);
                applyFilters(); // Initial filter apply
                trackEvent('data_fetch_success', { entries_count: allEntries.length });
            } catch (error) {
                console.error('Error fetching data!', error);
                recentEntriesContainer.innerHTML = `<p class="text-center text-xs text-red-500 py-4">Failed to load history.</p>`;
                homepageSummary.classList.add('hidden');
                trackEvent('data_fetch_error', { error: error.message });
            }
        }

        function renderRecentEntries(entries) {
            const recentEntriesContainer = document.getElementById('recent-entries');
            if (entries.length === 0) { recentEntriesContainer.innerHTML = '<p class="text-center text-xs text-gray-400 py-4">No recent activity.</p>'; return; }
            const recent = entries.slice(0, 5);
            const tagColorMap = { "Kirana": "bg-green-500", "Gosht": "bg-red-500", "Kheema": "bg-orange-500", "Gosht Kheema": "bg-red-600", "Chicken": "bg-yellow-400", "Mutton": "bg-red-500", "Bheja": "bg-pink-500", "Fish": "bg-sky-400", "Light Bill": "bg-indigo-500", "Society": "bg-teal-500" };
            const defaultColors = ["bg-blue-500", "bg-purple-500", "bg-pink-500", "bg-teal-500"];
            
            const entriesHTML = recent.map(([gAmount, zAmount, tag, timestamp]) => {
                const name = gAmount ? "Gulnaz" : "Ghazala";
                const amount = gAmount || zAmount;
                const tagInitial = tag ? tag.charAt(0).toUpperCase() : '?';
                let colorClass = tagColorMap[tag];
                if (!colorClass) { let hash = 0; for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash); const colorIndex = Math.abs(hash) % defaultColors.length; colorClass = defaultColors[colorIndex]; }
                return `<div class="modern-card p-4 flex items-center justify-between group hover:shadow-hover transition-all"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full ${colorClass} flex items-center justify-center text-base font-bold text-white shadow-sm flex-shrink-0">${tagInitial}</div><div class="flex flex-col"><span class="text-lg font-bold text-gray-900 leading-tight">${tag}</span><span class="text-base text-gray-500 font-medium mt-0.5">${name} Dena</span></div></div><div class="text-right flex flex-col items-end"><span class="text-lg font-bold text-gray-900 leading-tight">₹${formatAmount(amount)}</span><span class="text-base text-gray-400 font-medium mt-0.5">${formatTimestamp(timestamp)}</span></div></div>`;
            }).join('');
            recentEntriesContainer.innerHTML = entriesHTML;
        }
        
        function renderSummary(summary) {
            // Update Modal Summary (Removed)
            // const modalSummary = document.getElementById('summary-container');
            const homeSummary = document.getElementById('homepage-summary');
            
            if (!summary) return;
            const owes = summary.h1 || 'None';
            const diff = formatAmount(summary.i1);
            
            // Reduced font size from text-3xl to text-xl
            const summaryHTML = `
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-xs text-blue-600 font-bold uppercase tracking-widest mb-1">Net Balance</p>
                        <p class="text-xl font-medium text-gray-900 font-sans">${owes} owes <span class="font-bold">₹${diff}</span></p>
                    </div>
                </div>
                <div class="flex gap-6 text-sm text-gray-500 pt-4 border-t border-gray-100 font-medium">
                    <span>Gulnaz Dena: <span class="text-gray-900 font-semibold">₹${formatAmount(summary.f1)}</span></span>
                    <span>Ghazala Dena: <span class="text-gray-900 font-semibold">₹${formatAmount(summary.g1)}</span></span>
                </div>
            `;

            // modalSummary.innerHTML = summaryHTML;
            
            // Ensure homepage summary is visible and updated
            homeSummary.classList.remove('hidden');
            homeSummary.innerHTML = summaryHTML;
        }

        function populateYearOptions() {
            const yearSelect = document.getElementById('custom-year-input');
            const years = new Set(allEntries.map(e => new Date(e[3]).getFullYear()));
            const sortedYears = Array.from(years).sort().reverse();
            
            const currentVal = yearSelect.value;
            yearSelect.innerHTML = '<option value="" disabled selected>Select Year</option>';
            
            sortedYears.forEach(year => {
                if(!isNaN(year)) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if(year == currentVal) option.selected = true;
                    yearSelect.appendChild(option);
                }
            });
        }

        // --- FILTER & SORT LOGIC ---
        function applyFilters() {
            const query = document.getElementById('filter-input').value.toLowerCase();
            
            // 1. Text Search
            let tempEntries = allEntries.filter(entry => entry.some(cell => String(cell).toLowerCase().includes(query)));
            
            // 2. Date Filtering
            if (currentFilter !== 'all') {
                const now = new Date();
                tempEntries = tempEntries.filter(entry => {
                    const entryDate = parseDate(entry[3]); // Use robust parser
                    
                    if (currentFilter === 'this_month') {
                        return entryDate.getMonth() === now.getMonth() && entryDate.getFullYear() === now.getFullYear();
                    } else if (currentFilter === 'last_month') {
                        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        return entryDate.getMonth() === lastMonth.getMonth() && entryDate.getFullYear() === lastMonth.getFullYear();
                    } else if (currentFilter === 'last_30') {
                        const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                        return entryDate >= thirtyDaysAgo;
                    } else if (currentFilter === 'custom_date' && customDateVal) {
                        return entryDate.toDateString() === parseDate(customDateVal).toDateString();
                    } else if (currentFilter === 'custom_month' && customMonthVal) {
                        const [y, m] = customMonthVal.split('-');
                        return entryDate.getFullYear() == y && (entryDate.getMonth() + 1) == m;
                    } else if (currentFilter === 'custom_year' && customYearVal) {
                        return entryDate.getFullYear() == customYearVal;
                    }
                    return true;
                });
            }

            // 3. Sorting
            tempEntries.sort((a, b) => {
                let dateA = parseDate(a[3]), dateB = parseDate(b[3]);
                let amtA = (parseFloat(a[0]) || 0) + (parseFloat(a[1]) || 0); // Gulnaz + Ghazala
                let amtB = (parseFloat(b[0]) || 0) + (parseFloat(b[1]) || 0);

                if (currentSort === 'newest') return dateB - dateA;
                if (currentSort === 'oldest') return dateA - dateB;
                if (currentSort === 'high_low') return amtB - amtA;
                if (currentSort === 'low_high') return amtA - amtB;
                return 0;
            });

            filteredEntries = tempEntries;
            visibleCount = INITIAL_LOAD_COUNT;
            renderEntries();
        }

        function renderEntries() {
            if (currentView === 'feed') renderFeedView();
            else if (currentView === 'ledger') renderLedgerView();
            else if (currentView === 'calendar') renderCalendarView();
            else if (currentView === 'split') renderSplitView();
            renderLoadMoreButtons();
        }

        function renderFeedView() {
            const container = document.getElementById('entries-content-area');
            if (filteredEntries.length === 0) { container.innerHTML = `<p class="text-center py-12 text-gray-400 font-medium">No entries found.</p>`; return; }

            // Group by Date
            const groups = {};
            const today = new Date().toDateString();
            const yesterday = new Date(new Date().setDate(new Date().getDate() - 1)).toDateString();

            const tagColorMap = { "Kirana": "bg-green-500", "Gosht": "bg-red-500", "Kheema": "bg-orange-500", "Gosht Kheema": "bg-red-600", "Chicken": "bg-yellow-400", "Mutton": "bg-red-500", "Bheja": "bg-pink-500", "Fish": "bg-sky-400", "Light Bill": "bg-indigo-500", "Society": "bg-teal-500" };
            const defaultColors = ["bg-blue-500", "bg-purple-500", "bg-pink-500", "bg-teal-500"];

            filteredEntries.slice(0, visibleCount).forEach(entry => {
                const dateObj = parseDate(entry[3]); // Use robust parser
                const dateStr = dateObj.toDateString();
                let label = dateStr;
                if (dateStr === today) label = "Today";
                else if (dateStr === yesterday) label = "Yesterday";
                else label = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                if (!groups[label]) groups[label] = [];
                groups[label].push(entry);
            });

            let html = '';
            for (const [label, entries] of Object.entries(groups)) {
                html += `
                    <div class="bg-gray-50 border-b border-gray-200 px-4 py-2 sticky top-0 z-10 font-bold text-xs text-gray-500 uppercase tracking-wide flex justify-between">
                        <span>${label}</span>
                    </div>
                    <div class="bg-white">
                `;
                
                entries.forEach(entry => {
                    const [gAmount, zAmount, tag, timestamp] = entry;
                    const amount = gAmount || zAmount;
                    const payerName = gAmount ? 'Gulnaz' : 'Ghazala';
                    const tagInitial = tag ? tag.charAt(0).toUpperCase() : '?';
                    let colorClass = tagColorMap[tag];
                    if (!colorClass) { let hash = 0; for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash); const colorIndex = Math.abs(hash) % defaultColors.length; colorClass = defaultColors[colorIndex]; }
                    
                    html += `
                        <div class="px-4 py-4 flex items-center justify-between border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center text-xs font-bold text-white shadow-sm flex-shrink-0">
                                    ${tagInitial}
                                </div>
                                <div>
                                    <p class="text-base font-bold text-gray-900">${tag}</p>
                                    <p class="text-sm text-gray-500 font-medium">${payerName} Dena</p>
                                </div>
                            </div>
                            <span class="text-base font-bold text-gray-900">₹${formatAmount(amount)}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        function renderLedgerView() {
            const container = document.getElementById('entries-content-area');
            if (filteredEntries.length === 0) { container.innerHTML = `<p class="text-center py-12 text-gray-400 font-medium">No entries found.</p>`; return; }

            const tagColorMap = { "Kirana": "bg-green-500", "Gosht": "bg-red-500", "Kheema": "bg-orange-500", "Gosht Kheema": "bg-red-600", "Chicken": "bg-yellow-400", "Mutton": "bg-red-500", "Bheja": "bg-pink-500", "Fish": "bg-sky-400", "Light Bill": "bg-indigo-500", "Society": "bg-teal-500" };
            const defaultColors = ["bg-blue-500", "bg-purple-500", "bg-pink-500", "bg-teal-500"];

            let rows = filteredEntries.slice(0, visibleCount).map(([g, z, tag, time]) => {
                const tagInitial = tag ? tag.charAt(0).toUpperCase() : '?';
                let colorClass = tagColorMap[tag];
                if (!colorClass) { let hash = 0; for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash); const colorIndex = Math.abs(hash) % defaultColors.length; colorClass = defaultColors[colorIndex]; }

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${colorClass} flex items-center justify-center text-[10px] font-bold text-white shadow-sm flex-shrink-0">
                                    ${tagInitial}
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 block text-base leading-tight">${tag}</span>
                                    <span class="text-xs text-gray-400 block mt-0.5">${formatTimestamp(time)}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-right font-bold text-sm text-gray-900">${g ? '₹'+formatAmount(g) : '-'}</td>
                        <td class="px-4 py-4 text-right font-bold text-sm text-gray-900">${z ? '₹'+formatAmount(z) : '-'}</td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="w-full text-left bg-white">
                    <thead class="sticky top-0 z-20">
                        <tr class="bg-gray-50 text-xs text-gray-500 uppercase tracking-wider border-b border-gray-200">
                            <th class="px-4 py-3 font-bold">Category</th>
                            <th class="px-4 py-3 font-bold text-right">Gulnaz</th>
                            <th class="px-4 py-3 font-bold text-right">Ghazala</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function renderSplitView() {
            const container = document.getElementById('entries-content-area');
            if (filteredEntries.length === 0) { container.innerHTML = `<p class="text-center py-12 text-gray-400 font-medium">No entries found.</p>`; return; }

            let gulnazTotal = 0;
            let ghazalaTotal = 0;
            let gulnazRows = '';
            let ghazalaRows = '';

            filteredEntries.forEach(([g, z, tag, time]) => {
                if (g) {
                    gulnazTotal += parseFloat(g);
                    // Updated to show full time string
                    gulnazRows += `
                        <div class="border-b border-gray-50 py-3 last:border-0">
                            <div class="flex justify-between text-sm font-bold text-gray-800"><span>${tag}</span><span>₹${formatAmount(g)}</span></div>
                            <div class="text-xs text-gray-400 mt-1 font-medium">${formatTimestamp(time)}</div>
                        </div>
                    `;
                }
                if (z) {
                    ghazalaTotal += parseFloat(z);
                    // Updated to show full time string
                    ghazalaRows += `
                        <div class="border-b border-gray-50 py-3 last:border-0">
                            <div class="flex justify-between text-sm font-bold text-gray-800"><span>${tag}</span><span>₹${formatAmount(z)}</span></div>
                            <div class="text-xs text-gray-400 mt-1 font-medium">${formatTimestamp(time)}</div>
                        </div>
                    `;
                }
            });

            container.innerHTML = `
                <div class="flex h-full bg-white divide-x divide-gray-100">
                    <div class="flex-1 flex flex-col">
                        <div class="bg-purple-50 p-4 border-b border-purple-100 text-center sticky top-0 z-10">
                            <span class="text-xs font-bold text-purple-600 block mb-1 uppercase tracking-wide">GULNAZ</span>
                            <span class="text-lg font-bold text-gray-900">₹${formatAmount(gulnazTotal)}</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-1">${gulnazRows || '<p class="text-center text-xs text-gray-400 mt-4">No entries</p>'}</div>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <div class="bg-teal-50 p-4 border-b border-teal-100 text-center sticky top-0 z-10">
                            <span class="text-xs font-bold text-teal-600 block mb-1 uppercase tracking-wide">GHAZALA</span>
                            <span class="text-lg font-bold text-gray-900">₹${formatAmount(ghazalaTotal)}</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-1">${ghazalaRows || '<p class="text-center text-xs text-gray-400 mt-4">No entries</p>'}</div>
                    </div>
                </div>
            `;
        }

        // Variable to track selected day in calendar view
        let selectedCalendarDay = null;

        function renderCalendarView() {
            const container = document.getElementById('entries-content-area');
            
            // Use state variable for navigation
            let year = calendarViewDate.getFullYear();
            let month = calendarViewDate.getMonth();
            // Note: filter-input is hidden in calendar view, but we check just in case
            const query = document.getElementById('filter-input').value.toLowerCase();

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay(); // 0 is Sunday

            // Filter ALL entries for this specific month (ignoring global time filter to allow navigation)
            const monthEntries = allEntries.filter(entry => {
                if (query && !entry.some(cell => String(cell).toLowerCase().includes(query))) {
                    return false;
                }
                const d = parseDate(entry[3]); // Use robust parser
                return d.getMonth() === month && d.getFullYear() === year;
            });

            // Map entries to days
            const dayEntries = {};
            monthEntries.forEach(entry => {
                const d = parseDate(entry[3]); // Use robust parser
                const day = d.getDate();
                if (!dayEntries[day]) dayEntries[day] = [];
                dayEntries[day].push(entry);
            });

            // Grid Generation
            let calendarGrid = '';
            for (let i = 0; i < firstDay; i++) calendarGrid += `<span></span>`;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const hasEntries = dayEntries[day];
                const isSelected = selectedCalendarDay === day;
                let cellClasses = 'aspect-square flex flex-col items-center justify-center relative rounded-xl text-sm font-medium transition-all cursor-pointer border border-transparent select-none tap-highlight-transparent';
                let dots = '';
                
                if (isSelected) {
                    cellClasses += ' bg-blue-500 text-white shadow-md transform scale-105 z-10';
                } else if (hasEntries) {
                    cellClasses += ' bg-gray-50 text-gray-900 hover:bg-gray-100 hover:border-gray-200';
                    const hasGulnaz = hasEntries.some(e => e[0]);
                    const hasGhazala = hasEntries.some(e => e[1]);
                    
                    dots = `<div class="flex gap-1 mt-1">`;
                    if (hasGulnaz) dots += `<div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>`;
                    if (hasGhazala) dots += `<div class="w-1.5 h-1.5 rounded-full bg-teal-500"></div>`;
                    dots += `</div>`;
                } else {
                    cellClasses += ' text-gray-400 hover:text-gray-600';
                }

                calendarGrid += `<div class="calendar-day ${cellClasses}" data-day="${day}">${day}${dots}</div>`;
            }

            // List Generation (Bottom Half)
            let detailsHTML = '';
            const displayEntries = selectedCalendarDay ? (dayEntries[selectedCalendarDay] || []) : monthEntries;
            displayEntries.sort((a, b) => parseDate(b[3]) - parseDate(a[3]));

            if (displayEntries.length > 0) {
                detailsHTML = displayEntries.map(entry => {
                    const [g, z, tag, time] = entry;
                    const amount = g || z;
                    const payer = g ? 'Gulnaz' : 'Ghazala';
                    const color = g ? 'text-purple-600 bg-purple-50' : 'text-teal-600 bg-teal-50';
                    return `
                        <div class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-xl mb-2 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-xs font-bold">${payer.charAt(0)}</div>
                                <div>
                                    <p class="text-sm font-bold text-gray-900">${tag}</p>
                                    <p class="text-sm text-gray-500 font-medium">${payer} Dena <span class="mx-1">•</span> ${formatTimestamp(time)}</p>
                                </div>
                            </div>
                            <span class="text-sm font-bold text-gray-900">₹${formatAmount(amount)}</span>
                        </div>
                    `;
                }).join('');
            } else {
                detailsHTML = `<p class="text-center text-sm text-gray-400 py-8">${selectedCalendarDay ? 'No entries on this day.' : 'No transactions this month.'}</p>`;
            }

            container.innerHTML = `
                <div class="flex flex-col h-full bg-white">
                    <!-- Calendar Header & Grid -->
                    <div class="p-4 border-b border-gray-100 flex-none bg-white z-10">
                        <div class="flex items-center justify-between mb-4">
                            <button id="cal-prev-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-500 transition-colors active:bg-gray-200">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            
                            <!-- Clickable Month/Year with Native Picker -->
                            <div class="text-center relative">
                                <div class="relative inline-block group cursor-pointer">
                                    <span class="font-bold text-gray-900 text-lg block leading-none group-hover:text-blue-600 transition-colors select-none">${monthNames[month]} ${year}</span>
                                    <input type="month" id="cal-month-picker" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" value="${year}-${String(month + 1).padStart(2, '0')}">
                                </div>
                                ${selectedCalendarDay ? `<button id="clear-cal-selection" class="text-xs text-blue-600 font-bold hover:underline mt-1 block w-full relative z-10">Show Month</button>` : ''}
                            </div>

                            <button id="cal-next-btn" class="p-2 rounded-full hover:bg-gray-100 text-gray-500 transition-colors active:bg-gray-200">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center mb-2">
                            <span class="text-xs text-gray-400 font-bold">S</span>
                            <span class="text-xs text-gray-400 font-bold">M</span>
                            <span class="text-xs text-gray-400 font-bold">T</span>
                            <span class="text-xs text-gray-400 font-bold">W</span>
                            <span class="text-xs text-gray-400 font-bold">T</span>
                            <span class="text-xs text-gray-400 font-bold">F</span>
                            <span class="text-xs text-gray-400 font-bold">S</span>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center">
                            ${calendarGrid}
                        </div>
                    </div>
                    
                    <!-- Details List -->
                    <div class="flex-1 overflow-y-auto bg-gray-50 p-4 overscroll-contain">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">
                            ${selectedCalendarDay ? `Entries for ${monthNames[month]} ${selectedCalendarDay}` : `All Entries in ${monthNames[month]}`}
                        </h4>
                        ${detailsHTML}
                    </div>
                </div>
            `;

            // Month Picker Listener
            const monthPicker = document.getElementById('cal-month-picker');
            if (monthPicker) {
                monthPicker.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const [y, m] = e.target.value.split('-');
                        calendarViewDate = new Date(parseInt(y), parseInt(m) - 1, 1);
                        selectedCalendarDay = null; // Reset day selection
                        renderCalendarView();
                    }
                });
            }

            // Add Event Listeners for Days
            document.querySelectorAll('.calendar-day').forEach(el => {
                el.addEventListener('click', (e) => {
                    const day = parseInt(e.currentTarget.dataset.day);
                    if (selectedCalendarDay === day) {
                        selectedCalendarDay = null; // Toggle off
                    } else {
                        selectedCalendarDay = day;
                    }
                    renderCalendarView(); // Re-render
                });
            });

            // Navigation Listeners
            document.getElementById('cal-prev-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                calendarViewDate.setMonth(calendarViewDate.getMonth() - 1);
                selectedCalendarDay = null;
                renderCalendarView();
            });

            document.getElementById('cal-next-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                calendarViewDate.setMonth(calendarViewDate.getMonth() + 1);
                selectedCalendarDay = null;
                renderCalendarView();
            });

            // Clear Selection Listener
            const clearBtn = document.getElementById('clear-cal-selection');
            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedCalendarDay = null;
                    renderCalendarView();
                });
            }
        }

        function renderLoadMoreButtons() {
            // Hide load more buttons in calendar/split view as they handle their own scrolling/data
            const container = document.getElementById('load-more-container');
            
            if (currentView === 'calendar' || currentView === 'split') {
                container.innerHTML = '';
                container.classList.add('hidden');
                return;
            } else {
                container.classList.remove('hidden');
            }

            if (visibleCount >= filteredEntries.length) {
                container.innerHTML = `<p class="text-xs text-gray-400 font-medium">End of list.</p>`;
                return;
            }
            const remaining = filteredEntries.length - visibleCount;
            container.innerHTML = `
                <button data-amount="50" class="load-more-btn px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-xs text-gray-600 hover:bg-gray-50 mx-1 font-bold shadow-sm transition-all">Load 50</button>
                <button data-amount="${remaining}" class="load-more-btn px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-xs text-gray-600 hover:bg-gray-50 mx-1 font-bold shadow-sm transition-all">Load All (${remaining})</button>
            `;
            document.querySelectorAll('.load-more-btn').forEach(btn => btn.addEventListener('click', handleLoadMore));
        }

        function handleLoadMore(e) {
            const amount = parseInt(e.currentTarget.dataset.amount, 10);
            visibleCount += amount;
            renderEntries();
            trackEvent('load_more_entries', { amount: amount });
        }
    </script>
</body>
</html>
